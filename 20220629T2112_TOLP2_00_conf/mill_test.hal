# Generated by stepconf 1.1 at Tue Jun 28 21:21:33 2022
# If you make changes to this file, they will be
# overwritten when you run stepconf again
loadrt [KINS]KINEMATICS
loadrt [EMCMOT]EMCMOT servo_period_nsec=[EMCMOT]SERVO_PERIOD num_joints=[KINS]JOINTS
loadrt litexcnc
loadrt litexcnc_eth config_file="[LITEXCNC]CONFIG_FILE"

# Add the functions to the thread
addf [LITEXCNC](NAME).read servo-thread
addf motion-command-handler servo-thread
addf motion-controller servo-thread
addf [LITEXCNC](NAME).write servo-thread

# Set the time-out for the watchdog
setp [LITEXCNC](NAME).watchdog.timeout_ns 15000000

net spindle-cmd-rpm => [LITEXCNC](NAME).pwm.00.value
net spindle-on <= spindle.0.on => [LITEXCNC](NAME).pwm.00.enable
setp [LITEXCNC](NAME).pwm.00.pwm_freq 0.0
setp [LITEXCNC](NAME).pwm.00.scale 24000.0
setp [LITEXCNC](NAME).pwm.00.offset 0.0
#setp pwmgen.0.dither-pwm true
net spindle-cmd-rpm     <= spindle.0.speed-out
net spindle-cmd-rpm-abs <= spindle.0.speed-out-abs
net spindle-cmd-rps     <= spindle.0.speed-out-rps
net spindle-cmd-rps-abs <= spindle.0.speed-out-rps-abs
net spindle-at-speed    => spindle.0.at-speed
net spindle-cw <= spindle.0.forward

#net estop-out       => parport.0.pin-01-out

net  estop-out       => [LITEXCNC](NAME).stepgen.00.debug
setp [LITEXCNC](NAME).stepgen.00.position-scale [JOINT_0]SCALE
setp [LITEXCNC](NAME).stepgen.00.steplen         5000
setp [LITEXCNC](NAME).stepgen.00.stepspace       5000
setp [LITEXCNC](NAME).stepgen.00.dir-hold-time   10000
setp [LITEXCNC](NAME).stepgen.00.dir-setup-time  10000
setp [LITEXCNC](NAME).stepgen.00.maxvel   [JOINT_0]MAX_VELOCITY
setp [LITEXCNC](NAME).stepgen.00.maxaccel [JOINT_0]STEPGEN_MAXACCEL
net xpos-cmd joint.0.motor-pos-cmd => [LITEXCNC](NAME).stepgen.00.position-cmd
net xpos-fb [LITEXCNC](NAME).stepgen.00.position_prediction => joint.0.motor-pos-fb
net xenable joint.0.amp-enable-out => [LITEXCNC](NAME).stepgen.00.enable

setp [LITEXCNC](NAME).stepgen.01.position-scale [JOINT_1]SCALE
setp [LITEXCNC](NAME).stepgen.01.steplen         5000
setp [LITEXCNC](NAME).stepgen.01.stepspace       5000
setp [LITEXCNC](NAME).stepgen.01.dir-hold-time   10000
setp [LITEXCNC](NAME).stepgen.01.dir-setup-time  10000
setp [LITEXCNC](NAME).stepgen.01.maxvel   [JOINT_1]MAX_VELOCITY
setp [LITEXCNC](NAME).stepgen.01.maxaccel [JOINT_1]STEPGEN_MAXACCEL
net ypos-cmd joint.1.motor-pos-cmd => [LITEXCNC](NAME).stepgen.01.position-cmd
net ypos-fb [LITEXCNC](NAME).stepgen.01.position_prediction => joint.1.motor-pos-fb
net yenable joint.1.amp-enable-out => [LITEXCNC](NAME).stepgen.01.enable

setp [LITEXCNC](NAME).stepgen.02.position-scale [JOINT_2]SCALE
setp [LITEXCNC](NAME).stepgen.02.steplen         5000
setp [LITEXCNC](NAME).stepgen.02.stepspace       5000
setp [LITEXCNC](NAME).stepgen.02.dir-hold-time   10000
setp [LITEXCNC](NAME).stepgen.02.dir-setup-time  10000
setp [LITEXCNC](NAME).stepgen.02.maxvel   [JOINT_2]MAX_VELOCITY
setp [LITEXCNC](NAME).stepgen.02.maxaccel [JOINT_2]STEPGEN_MAXACCEL
net zpos-cmd joint.2.motor-pos-cmd => [LITEXCNC](NAME).stepgen.02.position-cmd
net zpos-fb [LITEXCNC](NAME).stepgen.02.position_prediction => joint.2.motor-pos-fb
net zenable joint.2.amp-enable-out => [LITEXCNC](NAME).stepgen.02.enable

net estop-out <= iocontrol.0.user-enable-out
net estop-out => iocontrol.0.emc-enable-in

loadusr -W hal_manualtoolchange
net tool-change iocontrol.0.tool-change => hal_manualtoolchange.change
net tool-changed iocontrol.0.tool-changed <= hal_manualtoolchange.changed
net tool-number iocontrol.0.tool-prep-number => hal_manualtoolchange.number
net tool-prepare-loopback iocontrol.0.tool-prepare => iocontrol.0.tool-prepared
